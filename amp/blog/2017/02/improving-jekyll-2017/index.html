<!doctype html>
<html amp lang="en">



  <meta charset="utf-8">
  <title>Improving Jekyll in 2017</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">

  <!-- Chrome, Firefox OS and Opera -->
  <meta name="theme-color" content="#3d256d">
  <!-- Windows Phone -->
  <meta name="msapplication-navbutton-color" content="#3d256d">

  <!-- Contain all special checks needed on AMP pages. Attempt to consolidate checks. -->


  
  <!-- Extract extra <title> tag. -->
  
  
  
  

  
  
  
  

  
    <!-- Assumes AmpDir is always first instance in page.url based on how amp-jekyll builds it -->
    
    

    <!-- Begin Jekyll SEO tag v2.8.0 -->

<meta name="generator" content="Jekyll v4.4.1">

<meta name="author" content="Kyle Niewiada">
<meta property="og:locale" content="en_US">
<meta name="description" content="My Jekyll website needed an update; so I fixed that. This is how I added tests, Travis-CI builds, Accelerated Mobile Pages, SEO improvements, and more.">
<meta property="og:description" content="My Jekyll website needed an update; so I fixed that. This is how I added tests, Travis-CI builds, Accelerated Mobile Pages, SEO improvements, and more.">
<link rel="canonical" href="/blog/2017/02/improving-jekyll-2017/">
<meta property="og:url" content="/blog/2017/02/improving-jekyll-2017/">
<meta property="og:site_name" content="Kyle Niewiada’s Website">
<meta property="og:image" content="https://www.kyleniewiada.org/assets/img/2017/02/banner.png">
<meta property="og:image:height" content="400">
<meta property="og:image:width" content="700">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2017-02-22T05:34:00-05:00">
<meta name="twitter:card" content="summary_large_image">
<meta property="twitter:image" content="https://www.kyleniewiada.org/assets/img/2017/02/banner.png">
<meta property="twitter:title" content="Improving Jekyll in 2017">
<meta name="twitter:site" content="@CrypticCitrus">
<meta name="twitter:creator" content="@CrypticCitrus">
<meta property="fb:app_id" content="137961485759">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Kyle Niewiada"},"dateModified":"2017-02-22T05:34:00-05:00","datePublished":"2017-02-22T05:34:00-05:00","description":"My Jekyll website needed an update; so I fixed that. This is how I added tests, Travis-CI builds, Accelerated Mobile Pages, SEO improvements, and more.","headline":"Improving Jekyll in 2017","image":{"height":400,"width":700,"url":"https://www.kyleniewiada.org/assets/img/2017/02/banner.png","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"/blog/2017/02/improving-jekyll-2017/"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://www.kyleniewiada.org/assets/img/logo.png"},"name":"Kyle Niewiada"},"url":"/blog/2017/02/improving-jekyll-2017/"}</script>
<!-- End Jekyll SEO tag -->

  



  <style amp-custom>
  
  @font-face{font-family:"Open Sans";font-display:swap;font-style:normal;font-weight:300;src:local("Open Sans Light"),local("OpenSans-Light"),url("/assets/fonts/open-sans-v17-latin-300.woff2") format("woff2"),url("/assets/fonts/open-sans-v17-latin-300.woff") format("woff")}@font-face{font-family:"Open Sans";font-display:swap;font-style:normal;font-weight:400;src:local("Open Sans"),local("OpenSans"),url("/assets/fonts/open-sans-v17-latin-regular.woff2") format("woff2"),url("/assets/fonts/open-sans-v17-latin-regular.woff") format("woff")}@font-face{font-family:"Open Sans";font-display:swap;font-style:normal;font-weight:600;src:local("Open Sans Semibold"),local("OpenSans-Semibold"),url("/assets/fonts/open-sans-v17-latin-600.woff2") format("woff2"),url("/assets/fonts/open-sans-v17-latin-600.woff") format("woff")}.page-title{text-align:left;font-size:200%;line-height:1.2;font-weight:normal}@media(min-width: 600px){.page-title{font-size:250%}}@media(min-width: 1000px){.page-title{font-size:300%}}.meta{color:dimgray;font-weight:300;font-size:120%}@media(min-width: 600px){.meta{font-size:130%}}@media(min-width: 1000px){.meta{font-size:140%}}.sub-meta{color:dimgray;font-weight:300;font-size:100%}@media(min-width: 600px){.sub-meta{font-size:110%}}@media(min-width: 1000px){.sub-meta{font-size:120%}}a.meta{text-align:center;display:block}.title-meta{overflow:auto;color:dimgray;font-size:100%}h1,.h1,h2,.h2,h3,.h3,h4,.h4,h5,.h5,h6,.h6{margin:0 0 .5rem;font-weight:600}a{color:#3d256d}a:hover{color:hsl(260,49.3150684932%,13.6274509804%)}code,pre{border-radius:.2em;background-color:#f5f5f5;border:.1em solid #d3d3d3}code{padding:2px 4px;color:#902f74}pre{padding:16px;overflow-y:hidden}pre code{color:inherit;background-color:rgba(0,0,0,0);padding:0;border:0}h1 .octicon,h2 .octicon,h3 .octicon,h4 .octicon,h5 .octicon,h6 .octicon{visibility:hidden}h1:hover .octicon,h2:hover .octicon,h3:hover .octicon,h4:hover .octicon,h5:hover .octicon,h6:hover .octicon{visibility:visible}.octicon{fill:currentColor;padding:0;vertical-align:middle}body{margin:0}body,p,li,ul,input,textarea{font-size:1em;line-height:1.58;color:#111;font-family:"Open Sans",Helvetica,Arial,sans-serif;overflow-wrap:break-word}img,video,audio,iframe,object{max-width:100%}main{display:block}.line-separator{height:2px;background:#d3d3d3;margin-top:16px;margin-bottom:16px}.clearfix:after{content:"";display:block;clear:both}.content{max-width:700px;margin-right:auto;margin-left:auto;padding:0 16px}.content img{display:block;margin-left:auto;margin-right:auto}.content video{display:block;margin-left:auto;margin-right:auto}.no-list{list-style:none;padding-left:0;margin-left:0}.left{float:left}.right{float:right}.post-list li{margin-bottom:4em;position:relative}.post-list li:before{content:"";position:absolute;bottom:-2em;left:0;background:hsl(0,0%,90%);height:2px;width:60px}.post-list li a{text-decoration:none}.post-list li a:hover{text-decoration:underline}.post-list li .date{color:dimgray;font-size:.8em}.header-amp{background:#262626;margin-bottom:16px;padding:16px;text-align:center;font-size:1.4em;font-weight:normal}.header-amp a,.header-amp a:hover{color:#fff;text-decoration:none;overflow:visible}

  

  
  footer{padding:16px 0}footer .flex-list{position:relative;margin:1em;overflow:hidden;border-top:1px solid #d3d3d3}footer .flex-list ul{display:flex;flex-direction:row;flex-wrap:wrap;justify-content:space-between;margin-left:-1px;padding:0}footer .flex-list li{list-style:none;flex-grow:1;flex-basis:auto;margin:.25em 0;padding:0 1em;text-align:center;border-left:1px solid #ccc;background-color:#fff}@media(min-width: 600px){footer .flex-list li{font-size:110%}}footer a{text-decoration:none}footer a:hover{background:#3d256d;color:#fff}article img+em,article amp-img+em,article video+em{text-align:center;font-size:.9em;font-style:italic;color:rgb(93.5,93.5,93.5);display:block}article img+p,article amp-img+p{margin-bottom:2em}blockquote{background:#ffa;border-left:10px solid #dc0;margin:1.5em 10px;padding:.5em 10px}.post-nav{display:flex;flex-direction:column}.post-nav .post-nav-link{height:6em;margin:.1em;overflow:hidden;position:relative}.post-nav .post-nav-link .link-text{z-index:1;position:absolute;height:100%;width:100%;box-sizing:border-box;padding:.5em;font-weight:bold;color:#fff;background:rgba(0,0,0,.6)}.post-nav .post-nav-link .previous{text-align:left}.post-nav .post-nav-link .next{text-align:right}.post-nav .post-nav-link .link-image{position:absolute;filter:blur(1px);transition:all .35s ease-in-out;top:50%;transform:translateY(-50%);width:auto;height:auto;min-width:100%;min-height:100%}.post-nav .post-nav-link:hover img{transform:translateY(-50%) scale(1.2)}@media all and (min-width: 600px){.post-nav{flex-direction:row}.post-nav .post-nav-link{flex-basis:0;flex-grow:1}}.button-outline{line-height:1.2em;padding:.5em 1.5em;border-radius:4px;text-decoration:none;cursor:pointer}.button-outline{background-color:rgba(0,0,0,0);border:3px solid #3d256d;color:#3d256d}.button-outline:hover{background-color:#3d256d;color:#fff}.highlight .c{color:#998;font-style:italic}.highlight .err{color:#a61717;background-color:#e3d2d2}.highlight .k{font-weight:bold}.highlight .o{font-weight:bold}.highlight .cm{color:#998;font-style:italic}.highlight .cp{color:#999;font-weight:bold}.highlight .c1{color:#998;font-style:italic}.highlight .cs{color:#999;font-weight:bold;font-style:italic}.highlight .gd{color:#000;background-color:#fdd}.highlight .gd .x{color:#000;background-color:#faa}.highlight .ge{font-style:italic}.highlight .gr{color:#a00}.highlight .gh{color:#999}.highlight .gi{color:#000;background-color:#dfd}.highlight .gi .x{color:#000;background-color:#afa}.highlight .go{color:#888}.highlight .gp{color:#555}.highlight .gs{font-weight:bold}.highlight .gu{color:#aaa}.highlight .gt{color:#a00}.highlight .kc{font-weight:bold}.highlight .kd{font-weight:bold}.highlight .kp{font-weight:bold}.highlight .kr{font-weight:bold}.highlight .kt{color:#458;font-weight:bold}.highlight .m{color:#099}.highlight .s{color:#d14}.highlight .na{color:teal}.highlight .nb{color:#0086b3}.highlight .nc{color:#458;font-weight:bold}.highlight .no{color:teal}.highlight .ni{color:purple}.highlight .ne{color:#900;font-weight:bold}.highlight .nf{color:#900;font-weight:bold}.highlight .nn{color:#555}.highlight .nt{color:navy}.highlight .nv{color:teal}.highlight .ow{font-weight:bold}.highlight .w{color:#bbb}.highlight .mf{color:#099}.highlight .mh{color:#099}.highlight .mi{color:#099}.highlight .mo{color:#099}.highlight .sb{color:#d14}.highlight .sc{color:#d14}.highlight .sd{color:#d14}.highlight .s2{color:#d14}.highlight .se{color:#d14}.highlight .sh{color:#d14}.highlight .si{color:#d14}.highlight .sx{color:#d14}.highlight .sr{color:#009926}.highlight .s1{color:#d14}.highlight .ss{color:#990073}.highlight .bp{color:#999}.highlight .vc{color:teal}.highlight .vg{color:teal}.highlight .vi{color:teal}.highlight .il{color:#099}details:not([open]) summary{border-radius:5px}details[open]{border-color:#bce5ff;border-bottom-style:solid;border-left-style:solid;border-right-style:solid}details[open] p{margin-left:16px;margin-right:16px}details[open] summary::after{transform:rotate(-180deg)}details{margin-top:16px;margin-bottom:16px}details summary{background-color:#bce5ff;list-style:none;color:#111;padding:16px;display:flex;justify-content:space-between;align-items:center}details summary::after{content:"";width:0;height:0;border-top:10px solid #111;border-inline:7px solid rgba(0,0,0,0);transition:.2s}details summary::-webkit-details-marker{display:none}details div:first-child{border-radius:0 0 5px 5px;border:.2em solid #e5e5e5}details pre:first-child{margin:0px;border-radius:0 0 .2em .2em}
  </style>

  <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>

  <script async custom-element="amp-analytics" src="https://cdn.ampproject.org/v0/amp-analytics-0.1.js"></script>
  <script async src="https://cdn.ampproject.org/v0.js"></script>
  
  



<body>
 <!-- https://github.com/analytics-debugger/google-analytics-4-for-amp -->
<amp-analytics type="googleanalytics" config="https://www.kyleniewiada.org/assets/ga4.json" data-credentials="include">
  <script type="application/json">
  {
      "vars": {
                  "GA4_MEASUREMENT_ID": "G-ZP46JK222K",
                  "GA4_ENDPOINT_HOSTNAME": "www.google-analytics.com",
                  "DEFAULT_PAGEVIEW_ENABLED": true,    
                  "GOOGLE_CONSENT_ENABLED": false,
                  "WEBVITALS_TRACKING": false,
                  "PERFORMANCE_TIMING_TRACKING": false,
                  "SEND_DOUBLECLICK_BEACON": false
      }
  }
  </script>
</amp-analytics>



<!-- start header -->
<header>
  <h1 class="header-amp">
    <a href="/">Kyle Niewiada</a>
  </h1>
</header>
<!-- end header -->



<main class="content">
  <article>
    <div class="post_info">
      <h1 class="page-title">Improving Jekyll in 2017</h1>

      <h2 class="meta">Kyle Niewiada

      <h3 class="meta">February 22, 2017 | 
        
          11 Minute Read
        
      </h3>

      
      <h4 class="sub-meta">Updated on August 11, 2020</h4>
        

      
      <div class="featuredImage">
        <amp-img src="/assets/img/2017/02/banner.png" alt="Travis-CI build log for my Jekyll site" width="700" height="400" layout="responsive"><noscript><img src="/assets/img/2017/02/banner.png" alt="Travis-CI build log for my Jekyll site" width="700" height="400"></noscript></amp-img>
      </div>
      

      <div class="line-separator"></div>

    </h2>
</div>

    <p>When I took a look at my website last year, it needed help. There wasn’t a whole lot wrong, but there definitely were areas that needed improvement. For starters, I wasn’t testing anything (don’t judge me). How would I test things? By overkilling the project and setting up <a href="https://travis-ci.com/">Travis-CI</a> of course.</p>

<p>Next, my website felt a little bulky. The CSS was over-the-top, I didn’t need a JavaScript header menu, I had unnecessary nested HTML tags, and still didn’t like how some of the elements collapsed on mobile devices.</p>

<p>The last major change that I wanted to implement was <strong>AMP</strong> (<a href="https://amp.dev/">accelerated mobile pages</a>) to make is easier for mobile devices hitting my blog. This led down a rabbit hole of further changes.</p>

<blockquote>
  <p>Link to the <a href="https://github.com/aav7fl/website/tree/2ff155a26e3c91837f35e794433fce7f3f020a30">website source code</a> right before this blog post was released; but it may be helpful to check out later revisions of code to see how things have changed.</p>
</blockquote>

<div class="line-separator"></div>
<h2>Table of Contents</h2>
<div class="table-of-contents">
<ul id="markdown-toc">
  <li>
<a href="#testing" id="markdown-toc-testing">Testing</a>    <ul>
      <li><a href="#html-proofer" id="markdown-toc-html-proofer">HTML Proofer</a></li>
      <li><a href="#amphtml-validator" id="markdown-toc-amphtml-validator">amphtml-validator</a></li>
      <li><a href="#rubocop" id="markdown-toc-rubocop">RuboCop</a></li>
    </ul>
  </li>
  <li><a href="#travis-ci" id="markdown-toc-travis-ci">Travis-CI</a></li>
  <li>
<a href="#amp-pages" id="markdown-toc-amp-pages">AMP Pages</a>    <ul>
      <li><a href="#amp-sitemap-conflict" id="markdown-toc-amp-sitemap-conflict">AMP Sitemap Conflict</a></li>
      <li><a href="#amp-seo-fixes" id="markdown-toc-amp-seo-fixes">AMP SEO Fixes</a></li>
      <li>
<a href="#amp-videos" id="markdown-toc-amp-videos">AMP Videos</a>        <ul>
          <li><a href="#fixing-the-head" id="markdown-toc-fixing-the-head">Fixing the &lt;Head&gt;</a></li>
          <li><a href="#fixing-the-post" id="markdown-toc-fixing-the-post">Fixing the Post</a></li>
        </ul>
      </li>
      <li><a href="#results" id="markdown-toc-results">Results</a></li>
    </ul>
  </li>
  <li>
<a href="#other-improvements" id="markdown-toc-other-improvements">Other Improvements</a>    <ul>
      <li><a href="#plugins" id="markdown-toc-plugins">Plugins</a></li>
      <li><a href="#website-wiki" id="markdown-toc-website-wiki">Website Wiki</a></li>
      <li><a href="#less-code-is-more" id="markdown-toc-less-code-is-more">Less Code is More</a></li>
    </ul>
  </li>
  <li><a href="#conclusion" id="markdown-toc-conclusion">Conclusion</a></li>
</ul>

</div>
<div class="line-separator"></div>

<h2 id="testing">Testing</h2>

<p>My website needed testing. I had no excuse. With every new feature added, there was another chance that something would slip by and ruin my production release. After adding AMP, I would manually validate each page in Google Chrome using the <code class="language-plaintext highlighter-rouge">#development=1</code> tag in my URL. For every change the HTML layout, I would miss a close tag. This needed to change.</p>

<h3 id="html-proofer">HTML Proofer</h3>

<p>My first improvement to testing my website was adding <a href="https://github.com/gjtorikian/html-proofer">HTMLProofer</a>. HTMLProofer “is a set of tests to validate your HTML output. These tests check if your image references are legitimate, if they have alt tags, if your internal links are working, and so on. It’s intended to be an all-in-one checker for your output.”</p>

<p>Cool, right? After I set up the RubyGem, I found some broken HTML tags, a few 404 outgoing links, and missing alt tags on images. A few problems solved.</p>

<h3 id="amphtml-validator">amphtml-validator</h3>

<p>After I implemented AMP (more on that later), I needed a better way to test rather than opening up my browser and validating each page through the Chrome dev tools. <a href="https://github.com/ampproject/amphtml/tree/main/validator/js/nodejs">amphtml-validator</a> to the rescue; a Node.js package command line tool that validates AMP HTML files.</p>

<p>With a little Ruby-Fu, I was able to add the Node.js package execution to my Rakefile. It finds all of the <code class="language-plaintext highlighter-rouge">*.html</code> files in my AMP directory and passes them one at a time to the amphtml-validator. I check the exit status of the Node.js package, let the user know if it fails, and continue with my day.</p>

<p><code class="language-plaintext highlighter-rouge">Rakefile</code></p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">desc</span> <span class="s1">'Test website AMP validation'</span>
<span class="n">task</span> <span class="ss">:amp</span> <span class="k">do</span>
  <span class="nb">puts</span> <span class="s1">'Running AMP Validator...'</span><span class="p">.</span><span class="nf">yellow</span><span class="p">.</span><span class="nf">bold</span>
  <span class="n">amp_dir</span> <span class="o">=</span> <span class="s1">'_site/amp'</span>
  <span class="nb">system</span><span class="p">(</span><span class="s2">"find </span><span class="si">#{</span><span class="n">amp_dir</span><span class="si">}</span><span class="s2"> -iname *.html | xargs -L1 amphtml-validator"</span><span class="p">)</span>
  <span class="k">if</span> <span class="vg">$CHILD_STATUS</span><span class="p">.</span><span class="nf">exitstatus</span><span class="p">.</span><span class="nf">zero?</span>
    <span class="nb">puts</span> <span class="s1">'AMP Validator finished successfully.'</span><span class="p">.</span><span class="nf">green</span>
  <span class="k">else</span>
    <span class="nb">puts</span> <span class="s1">'AMP Validator FAILED.'</span><span class="p">.</span><span class="nf">red</span><span class="p">.</span><span class="nf">bold</span>
    <span class="nb">exit</span><span class="p">(</span><span class="vg">$CHILD_STATUS</span><span class="p">.</span><span class="nf">exitstatus</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="rubocop">RuboCop</h3>

<p>When I was working on a pull request for another project, the project’s Rake tests introduced me to <a href="https://github.com/bbatsov/rubocop">RuboCop</a>. RuboCop is a static code analyzer for Ruby that enforces guidelines from the <a href="https://github.com/bbatsov/ruby-style-guide">Ruby Style Guide</a>. It was a neat little tool that I added to my Rakefile to ensure Ruby code that I wrote would be understood by others. It wasn’t a huge change, but it was there to keep myself in check with the community style guidelines (something that I had very little experience with).</p>

<p>I added this to my project by installing the RuboCop RubyGem and adding its config file. The config file excludes a directory that would currently break a Travis-CI build.</p>

<p><code class="language-plaintext highlighter-rouge">.rubocop.yml</code></p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">AllCops</span><span class="pi">:</span>
  <span class="na">Exclude</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">vendor/**/*</span> <span class="c1"># Ignore Travis-CI build directory</span>
</code></pre></div></div>

<h2 id="travis-ci">Travis-CI</h2>

<p>Adding tests were great. But I also liked the idea that if I was away from my build environment I could make a small change on my phone, test it, and deploy to production. This was a bit of a pipe dream for me. I knew as soon as I added tests, I wouldn’t be able to rely completely on GitHub builds. Likewise, if I wanted to add special plugins or RubyGems, say goodbye to GitHub builds.</p>

<p>But <a href="https://travis-ci.com/">Travis-CI</a> saves the day! Travis-CI will watch for code changes in my repo, fetch it, test it, and if it passes it could push my <code class="language-plaintext highlighter-rouge">_site/</code> folder to my GH-Pages branch (where GitHub will deploy online). Pretty cool, huh?</p>

<p>I stumbled across this idea from Savas Labs who wrote a blog post last fall on how they <a href="https://savaslabs.com/2016/10/25/deploy-jekyll-with-travis.html">deploy to GitHub Pages using Travis-CI</a>. They were not the first, but I liked some of the ideas that they used. They would bring in pull requests to the source branch, test it, and deploy to a master branch for GH-Pages based on test results. I have followed suit. I made some changes to the scripts, like how I cache different directories and rely on the built in Node.JS versions, but the idea is still the same.</p>

<p>I’m actually a little proud of this, but my build time is now around 1½ minutes, and deploying only takes another 15 seconds. This was accomplished by:</p>
<ul>
  <li>Caching Bundler</li>
  <li>Caching Node_Modules</li>
  <li>Resolving <a href="https://github.com/aav7fl/website/blob/72e003eba56facb762a0bd2ffb79876e5a9e299a/.travis.yml#L23">RVM and Node_Modules <code class="language-plaintext highlighter-rouge">which</code> conflict</a>. This shaved nearly a minute off the build!</li>
</ul>

<p>Read more on <a href="https://docs.travis-ci.com/user/caching/">Travis-CI caching docs</a>.</p>

<h2 id="amp-pages">AMP Pages</h2>

<p>Starting back in the middle of 2016, I wanted to implement AMP (<a href="https://amp.dev/">accelerated mobile pages</a>) in my website. In case you didn’t know, it’s a streamlined version of the webpage strongly optimized for mobile rendering and reduced load times. It also comes with its own special restrictions.</p>

<p>If there was something that would make the web experience faster for any readers, I was interested. My biggest problems were that Jekyll had yet to implement multiple layouts natively. This meant that I needed to rely on an external plugin in order to generate the AMP pages. Good thing I setup up Travis-CI!</p>

<p>I turned to <a href="https://github.com/juusaw/amp-jekyll">amp-jekyll</a> (which is now a RubyGem!) to add an AMP layout. There were a few small changes that I needed to make though. I had to figure out how to <a href="https://amp.dev/documentation/components/amp-video">properly add videos</a> to my posts, remove the AMP pages from my sitemap, and change the canonical URL on my AMP pages while using Jekyll-SEO-Tag.</p>

<h3 id="amp-sitemap-conflict">AMP Sitemap Conflict</h3>

<p>In order to avoid duplicate results, AMP pages are not <a href="https://x.com/JohnMu/status/786588362706673664">necessary in the sitemap</a> unless they are standalone pages. Referencing them in the <code class="language-plaintext highlighter-rouge">&lt;head&gt;</code> of the normal page is enough. Because <a href="https://github.com/jekyll/jekyll-sitemap">jekyll-sitemap</a> knew nothing about my AMP ambitions, I had to manually set a default in my <code class="language-plaintext highlighter-rouge">amp.html</code> layout frontmatter to stop them from being included.</p>

<p><code class="language-plaintext highlighter-rouge">_layouts/amp.html</code></p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">layout</span><span class="pi">:</span> <span class="s">amp</span>
<span class="na">sitemap</span><span class="pi">:</span> <span class="kc">false</span>
<span class="nn">---</span>
</code></pre></div></div>

<p>Easy enough.</p>

<h3 id="amp-seo-fixes">AMP SEO Fixes</h3>

<p>Next, my AMP pages had conflicts with  <a href="https://github.com/jekyll/jekyll-seo-tag">Jekyll-SEO-Tag</a>. Every AMP page would list its canonical URL as itself, when in reality it should be linking to the normal version of the webpage.</p>

<p><del>This was solved by cheating. I call it cheating because it’s not a robust solution. If I happen to include the <code class="language-plaintext highlighter-rouge">site.ampdir</code> anywhere in my SEO tags on an AMP page, that text will be removed.</del></p>

<p>The new method of changing the canonical url on AMP pages is accomplished by removing the first instance of <code class="language-plaintext highlighter-rouge">site.ampdir</code> in my <code class="language-plaintext highlighter-rouge">page.url</code> on pages whose layout is of type <code class="language-plaintext highlighter-rouge">amp</code>. I then rebuild the canonical url in the same format as Jekyll SEO Tag and update the JSON-LD with a small replace filter.</p>

<p>If my AMP Page canonical URL contained <code class="language-plaintext highlighter-rouge">/amp</code> like so:</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>href="https://www.kyleniewiada.org/amp/blog/2017/02/improving-jekyll-2017/"
</code></pre></div></div>
<p>It would now be altered to:</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>href="https://www.kyleniewiada.org/blog/2017/02/improving-jekyll-2017/"
</code></pre></div></div>

<p>Whenever I grab the SEO tag, I make sure to run in through my “parser” first to fix it. Here’s how I do it.</p>

<p><code class="language-plaintext highlighter-rouge">_includes/amp-check.html</code></p>

<div class="language-liquid highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">{%</span><span class="w"> </span><span class="nt">capture</span><span class="w"> </span><span class="nv">seo_text</span><span class="w"> </span><span class="cp">%}{%</span><span class="w"> </span><span class="nt">seo</span><span class="w"> </span><span class="cp">%}{%</span><span class="w"> </span><span class="nt">endcapture</span><span class="w"> </span><span class="cp">%}</span>

<span class="cp">{%</span><span class="w"> </span><span class="nt">if</span><span class="w"> </span><span class="nv">include</span><span class="p">.</span><span class="nv">src</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"SEO"</span><span class="w"> </span><span class="cp">%}</span>
  &lt;!-- Assumes AmpDir is always first instance in page.url based on how amp-jekyll builds it --&gt;
  <span class="cp">{%</span><span class="w"> </span><span class="nt">assign</span><span class="w"> </span><span class="nv">canonical_amp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">page</span><span class="p">.</span><span class="nv">url</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nf">absolute_url</span><span class="w"> </span><span class="cp">%}</span>
  <span class="cp">{%</span><span class="w"> </span><span class="nt">assign</span><span class="w"> </span><span class="nv">canonical_amp_removed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">page</span><span class="p">.</span><span class="nv">url</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nf">remove_first</span><span class="p">:</span><span class="w"> </span><span class="nv">site</span><span class="p">.</span><span class="nv">ampdir</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nf">absolute_url</span><span class="w"> </span><span class="cp">%}</span>
  <span class="cp">{{</span><span class="w"> </span><span class="nv">seo_text</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nf">replace</span><span class="p">:</span><span class="w"> </span><span class="nv">canonical_amp</span><span class="p">,</span><span class="w"> </span><span class="nv">canonical_amp_removed</span><span class="w"> </span><span class="cp">}}</span>
<span class="cp">{%</span><span class="w"> </span><span class="nt">endif</span><span class="w"> </span><span class="cp">%}</span>
</code></pre></div></div>

<p>Now all I need to do is call the Jekyll-SEO-Tag with <code class="language-plaintext highlighter-rouge">{% include amp-check.html src="SEO" %}</code> in the <code class="language-plaintext highlighter-rouge">&lt;head&gt;</code> of my layout. Problem solved.</p>

<h3 id="amp-videos">AMP Videos</h3>

<p>AMP Videos require a bit of finesse to implement. They need to have a special JS file loaded in the head and they need to follow the correct <a href="https://amp.dev/documentation/components/amp-video">amp-video guidelines</a>.</p>

<h4 id="fixing-the-head">Fixing the &lt;Head&gt;</h4>

<p>To get that <em>special JS file</em>, I decided the easiest way would be to add a frontmatter variable in each post stating which special AMP JS files were needed. Then I would make a check for it in the <code class="language-plaintext highlighter-rouge">&lt;head&gt;</code>. For example, a blog post with an embedded video would have:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">amp</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">video</span>
</code></pre></div></div>

<p>Then the AMP <code class="language-plaintext highlighter-rouge">&lt;head&gt;</code> layout would include:</p>

<p><code class="language-plaintext highlighter-rouge">_includes/amp/head.html</code></p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{% if page.amp contains 'video' %}
  <span class="nt">&lt;script </span><span class="na">async</span> <span class="na">custom-element=</span><span class="s">"amp-video"</span> <span class="na">src=</span><span class="s">"https://cdn.ampproject.org/v0/amp-video-0.1.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
{% endif %}
</code></pre></div></div>

<h4 id="fixing-the-post">Fixing the Post</h4>

<p>Now that the <code class="language-plaintext highlighter-rouge">&lt;head&gt;</code> had the correct dependencies, I had to figure out how to embed the video file in my blog post in the appropriate way for each page layout.</p>

<p>This was accomplished with a small <code class="language-plaintext highlighter-rouge">include</code> that would take in the parameters from a post specifying the video type and other special properties.</p>

<p>I would add a video to my post with:</p>

<div class="language-liquid highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">{%</span><span class="w"> </span><span class="nt">include</span><span class="w"> </span>video.html<span class="w">
  </span><span class="na">src</span><span class="o">=</span><span class="s2">"/assets/files/2016/03/bug_example.mp4"</span><span class="w">
  </span><span class="na">poster</span><span class="o">=</span><span class="s2">"/assets/files/2016/03/bug_example_poster.png"</span><span class="w">
  </span><span class="na">controls</span><span class="o">=</span><span class="s2">"loop"</span><span class="w">
</span><span class="cp">%}</span>
</code></pre></div></div>

<p>Then the video <code class="language-plaintext highlighter-rouge">include</code> would properly insert the video for both AMP and default layouts.</p>

<p><code class="language-plaintext highlighter-rouge">_includes/video.html</code></p>

<div class="language-liquid highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;!-- Method to implement AMP-Video. --&gt;
<span class="cp">{%</span><span class="w"> </span><span class="nt">assign</span><span class="w"> </span><span class="nv">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">include</span><span class="p">.</span><span class="nv">height</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nf">default</span><span class="p">:</span><span class="w"> </span><span class="s2">"420"</span><span class="w"> </span><span class="cp">%}</span>
<span class="cp">{%</span><span class="w"> </span><span class="nt">assign</span><span class="w"> </span><span class="nv">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">include</span><span class="p">.</span><span class="nv">width</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nf">default</span><span class="p">:</span><span class="w"> </span><span class="s2">"700"</span><span class="w"> </span><span class="cp">%}</span>
<span class="cp">{%</span><span class="w"> </span><span class="nt">assign</span><span class="w"> </span><span class="nv">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">include</span><span class="p">.</span><span class="nv">type</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nf">default</span><span class="p">:</span><span class="w"> </span><span class="s2">"normal"</span><span class="w"> </span><span class="cp">%}</span>

<span class="cp">{%</span><span class="w"> </span><span class="nt">if</span><span class="w"> </span><span class="nv">type</span><span class="w"> </span><span class="ow">contains</span><span class="w"> </span><span class="s1">'normal'</span><span class="w"> </span><span class="cp">%}</span>
  <span class="cp">{%</span><span class="w"> </span><span class="nt">if</span><span class="w"> </span><span class="nv">page</span><span class="p">.</span><span class="nv">layout</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">'amp'</span><span class="w"> </span><span class="cp">%}</span>
    &lt;amp-video height="<span class="cp">{{</span><span class="w"> </span><span class="nv">height</span><span class="w"> </span><span class="cp">}}</span>" width="<span class="cp">{{</span><span class="w"> </span><span class="nv">width</span><span class="w"> </span><span class="cp">}}</span>" poster="<span class="cp">{{</span><span class="w"> </span><span class="nv">include</span><span class="p">.</span><span class="nv">poster</span><span class="w"> </span><span class="cp">}}</span>" layout="responsive" controls <span class="cp">{{</span><span class="w"> </span><span class="nv">include</span><span class="p">.</span><span class="nv">controls</span><span class="w"> </span><span class="cp">}}</span>&gt;
      &lt;div fallback&gt;
        Your browser doesn’t support HTML5 video
      &lt;/div&gt;
      &lt;source type="video/mp4" src="<span class="cp">{{</span><span class="w"> </span><span class="nv">include</span><span class="p">.</span><span class="nv">src</span><span class="w"> </span><span class="cp">}}</span>"/&gt;
    &lt;/amp-video&gt;
  <span class="cp">{%</span><span class="w"> </span><span class="nt">else</span><span class="w"> </span><span class="cp">%}</span>
    &lt;video width="<span class="cp">{{</span><span class="w"> </span><span class="nv">width</span><span class="w"> </span><span class="cp">}}</span>" controls <span class="cp">{{</span><span class="w"> </span><span class="nv">include</span><span class="p">.</span><span class="nv">controls</span><span class="w"> </span><span class="cp">}}</span>&gt;
      &lt;source src="<span class="cp">{{</span><span class="w"> </span><span class="nv">include</span><span class="p">.</span><span class="nv">src</span><span class="w"> </span><span class="cp">}}</span>" type="video/mp4" /&gt;
      &lt;p&gt;Your browser doesn’t support HTML5 video&lt;/p&gt;
    &lt;/video&gt;
  <span class="cp">{%</span><span class="w"> </span><span class="nt">endif</span><span class="w"> </span><span class="cp">%}</span>
<span class="cp">{%</span><span class="w"> </span><span class="nt">endif</span><span class="w"> </span><span class="cp">%}</span>
</code></pre></div></div>

<p>In the code above, it first checks to see if the video type from the post is a “normal” embedded video, or a YouTube video (not shown). Next, it checks to see if the webpage layout is of type <code class="language-plaintext highlighter-rouge">amp</code>. If this is also true, then it will insert the correct HTML layout for an AMP video. Otherwise, it will insert the video with normal HTML5.</p>

<blockquote>
  <p>You can find more information or any updates to my implementation on the <a href="https://github.com/aav7fl/website/wiki">repo Wiki</a>.</p>
</blockquote>

<h3 id="results">Results</h3>

<p>Now when I run the <code class="language-plaintext highlighter-rouge">amphtml-validator</code> tests, all of my AMP pages pass.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Running AMP Validator...
_site/amp/blog/2013/04/somewhere-to-start/index.html: PASS
_site/amp/blog/2013/09/restoring-vintage-with-3d-printing/index.html: PASS
...
_site/amp/blog/2016/07/fixing-no-google-profile-for-contact/index.html: PASS
_site/amp/blog/2017/01/backing-up-android-nougat-cats/index.html: PASS
AMP Validator finished successfully.
</code></pre></div></div>

<p>An explanation on my testing method is found earlier in this post.</p>

<h2 id="other-improvements">Other Improvements</h2>

<p>Outside of testing/building, there were a few other improvements that I made to my website. I fixed conflicts with AMP pages and other plugins, added a wiki to the website repo, and put forth a small graphical upgrade with favicon branding and banners.</p>

<h3 id="plugins">Plugins</h3>

<p>Earlier in this post I talked about how I was using Travis-CI to build and deploy my website. Building outside of GitHub offered me the freedom to use my own plugins or RubyGems rather than limiting myself to the <a href="https://pages.github.com/versions/">GitHub-Pages Allowed Dependencies</a>. One of them I’ve already mentioned; amp-jekyll. This was used to implement an AMP layout to my blog postings.</p>

<p>The only custom RubyGem that I am using is Jekyll-SEO-Tag. Well… a fork of Jekyll-SEO-Tag. That is, until they hopefully accept my <a href="https://github.com/jekyll/jekyll-seo-tag/pull/151">pull request</a>. My pull request corrects and updates the JSON-LD for a blog post to meet Google’s current recommendations. But for now, I have a special entry in my Gemfile pointing to my fork.</p>

<p><code class="language-plaintext highlighter-rouge">Gemfile</code></p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">group</span> <span class="ss">:jekyll_plugins</span> <span class="k">do</span>
  <span class="n">git</span> <span class="s1">'https://github.com/aav7fl/jekyll-seo-tag.git'</span> <span class="k">do</span>
    <span class="n">gem</span> <span class="s1">'jekyll-seo-tag'</span><span class="p">,</span> <span class="ss">branch: </span><span class="s1">'testing'</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="website-wiki">Website Wiki</h3>

<p>I added a <a href="https://github.com/aav7fl/website/wiki">wiki to my website repo</a>
so others could build out their own project from my website if they wanted to. Additionally, the <code class="language-plaintext highlighter-rouge">README.md</code> for my repo was becoming far too large to include all of the information about how to build, customize, and deploy my website. This meant that I could make separate changes to the documentation without adding another code commit.</p>

<h3 id="less-code-is-more">Less Code is More</h3>

<p>Lastly, I made a substantial improvements to the CSS, lightened the webpage layout, and squashed remaining bugs that I could find (looking at you MS Edge…). Below is a fairly comprehensive list of the major changes I made. They don’t deserve their own individual section, but they are still worth mentioning</p>

<ul>
  <li>Removed CSS normalize/Strongly simplified</li>
  <li>Removed complicated JavaScript header navigation (CSS3 only now)</li>
  <li>Switched post-navigation and footer to use Flexbox that collapses responsively</li>
  <li>Switched to HTML5 tags (<code class="language-plaintext highlighter-rouge">&lt;main&gt;</code>, <code class="language-plaintext highlighter-rouge">&lt;article&gt;</code>, <code class="language-plaintext highlighter-rouge">&lt;footer&gt;</code>)</li>
  <li>Fixed SVG banner image bugs that existed in Edge/IE and iOS Safari
    <ul>
      <li>Edge/IE would not dislpay the SVG banner if it met the following conditions:
        <ul>
          <li>Set as a CSS background-image</li>
          <li>Displayed with <code class="language-plaintext highlighter-rouge">background-size: cover;</code>
</li>
          <li>Stretched too wide (it would disappear immediately).
This was resolved by adding <code class="language-plaintext highlighter-rouge">x="0" y="0"</code> to the <code class="language-plaintext highlighter-rouge">&lt;filter&gt;</code> tag in my SVG file. What a bug…</li>
        </ul>
      </li>
      <li>iOS Safari would display the banner with a smokey-white haze when using the Gaussian Blur filter as it somehow conflicted with the background layer. This was resolved by removing the background fill from the SVG and instead handling it with the <code class="language-plaintext highlighter-rouge">&lt;DIV&gt;</code> <code class="language-plaintext highlighter-rouge">background:</code>.</li>
    </ul>
  </li>
  <li>Added favicon sets (like Apple-Touch-Icon) using <a href="https://realfavicongenerator.net/">RealFaviconGenerator</a> with updated colors</li>
</ul>

<blockquote>
  <p>I’ve had a reader mention <a href="https://www.websiteplanet.com/webtools/favicon-generator/">WebsitePlanet</a> an alternative to RealFaviconGenerator. WebsitePlanet generates a bunch of different sizes at the same time; so keep that in mind if one website does it better than the other.</p>
</blockquote>

<h2 id="conclusion">Conclusion</h2>

<p>As much as I tried to stay entirely within the GitHub Pages ecosystem, it didn’t fit my needs. But that was a good thing. This gave me the chance to check out other build environments and different tools that wouldn’t have been in my reach before. This gave me the opportunity to look at other open source projects, to learn about their process, and contribute my own work back.</p>

<p>If you have any questions or concerns about how or why I did something, or I wasn’t clear on an explanation, feel free to comment about it below and I’ll try to get back to you.</p>


  </article>
</main>


<a href="/blog/2017/02/improving-jekyll-2017/" class="meta center">Comments are available on the full webpage.</a>


<!-- start footer -->
<footer class="content">
  <div class="flex-list">
  <ul>
  
    <li>
      <a href="https://www.linkedin.com/in/kyleniewiada/">LinkedIn</a>
    </li>
  
    <li>
      <a href="https://github.com/aav7fl">GitHub</a>
    </li>
  
    <li>
      <a href="https://bsky.app/profile/crypticcitrus.bsky.social">Bluesky</a>
    </li>
  
    <li>
      <a href="https://www.youtube.com/user/KyleNiewiada">YouTube</a>
    </li>
  
    <li>
      <a href="https://kyleniewiada.bandcamp.com/" rel="nofollow">BandCamp</a>
    </li>
  
    <li>
      <a href="/sitemap/">Sitemap</a>
    </li>
  
  </ul>
</div>

</footer>
<!-- end footer -->


</body>

</html>
