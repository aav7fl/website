<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Chrome, Firefox OS and Opera -->
    <meta name="theme-color" content="#3d256d">
    <!-- Windows Phone -->
    <meta name="msapplication-navbutton-color" content="#3d256d">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <link rel="shortcut icon" href="/favicon.ico">
    
      
        <link rel="amphtml" href="https://www.kyleniewiada.org/amp/blog/2020/07/replacing-z-wave-with-esphome/" data-proofer-ignore>
      
    

    <!-- Messy way to capture custom page title to replace SEO Tags -->
    
    
    <title>Deploying ESPHome Smart Plugs to Replace Z-Wave</title>
    <meta property="og:title" content="Deploying ESPHome Smart Plugs to Replace Z-Wave" />

    <!-- Come and get me RSS readers -->
    <link type="application/atom+xml" rel="alternate" href="https://www.kyleniewiada.org/feed.xml" title="Kyle Niewiada&apos;s Website" />

    <!-- Critical Stylesheet -->
    <style type="text/css">
      
      @font-face{font-family:"Open Sans";font-display:swap;font-style:normal;font-weight:300;src:local("Open Sans Light"),local("OpenSans-Light"),url("/assets/fonts/open-sans-v17-latin-300.woff2") format("woff2"),url("/assets/fonts/open-sans-v17-latin-300.woff") format("woff")}@font-face{font-family:"Open Sans";font-display:swap;font-style:normal;font-weight:400;src:local("Open Sans"),local("OpenSans"),url("/assets/fonts/open-sans-v17-latin-regular.woff2") format("woff2"),url("/assets/fonts/open-sans-v17-latin-regular.woff") format("woff")}@font-face{font-family:"Open Sans";font-display:swap;font-style:normal;font-weight:600;src:local("Open Sans Semibold"),local("OpenSans-Semibold"),url("/assets/fonts/open-sans-v17-latin-600.woff2") format("woff2"),url("/assets/fonts/open-sans-v17-latin-600.woff") format("woff")}.page-title{text-align:left;font-size:200%;line-height:1.2;font-weight:normal}@media(min-width: 600px){.page-title{font-size:250%}}@media(min-width: 1000px){.page-title{font-size:300%}}.meta{color:dimgray;font-weight:300;font-size:120%}@media(min-width: 600px){.meta{font-size:130%}}@media(min-width: 1000px){.meta{font-size:140%}}.sub-meta{color:dimgray;font-weight:300;font-size:100%}@media(min-width: 600px){.sub-meta{font-size:110%}}@media(min-width: 1000px){.sub-meta{font-size:120%}}a.meta{text-align:center;display:block}.title-meta{overflow:auto;color:dimgray;font-size:100%}h1,.h1,h2,.h2,h3,.h3,h4,.h4,h5,.h5,h6,.h6{margin:0 0 .5rem;font-weight:600}a{color:#3d256d}a:hover{color:hsl(260,49.3150684932%,13.6274509804%)}code,pre{border-radius:.2em;background-color:#f5f5f5;border:.1em solid #d3d3d3}code{padding:2px 4px;color:#902f74}pre{padding:16px;overflow-y:hidden}pre code{color:inherit;background-color:rgba(0,0,0,0);padding:0;border:0}h1 .octicon,h2 .octicon,h3 .octicon,h4 .octicon,h5 .octicon,h6 .octicon{visibility:hidden}h1:hover .octicon,h2:hover .octicon,h3:hover .octicon,h4:hover .octicon,h5:hover .octicon,h6:hover .octicon{visibility:visible}.octicon{fill:currentColor;padding:0;vertical-align:middle}body{margin:0}body,p,li,ul,input,textarea{font-size:1em;line-height:1.58;color:#111;font-family:"Open Sans",Helvetica,Arial,sans-serif;overflow-wrap:break-word}img,video,audio,iframe,object{max-width:100%}main{display:block}.line-separator{height:2px;background:#d3d3d3;margin-top:16px;margin-bottom:16px}.clearfix:after{content:"";display:block;clear:both}.content{max-width:700px;margin-right:auto;margin-left:auto;padding:0 16px}.content img{display:block;margin-left:auto;margin-right:auto}.content video{display:block;margin-left:auto;margin-right:auto}.no-list{list-style:none;padding-left:0;margin-left:0}.left{float:left}.right{float:right}.post-list li{margin-bottom:4em;position:relative}.post-list li:before{content:"";position:absolute;bottom:-2em;left:0;background:hsl(0,0%,90%);height:2px;width:60px}.post-list li a{text-decoration:none}.post-list li a:hover{text-decoration:underline}.post-list li .date{color:dimgray;font-size:.8em}.header{background-image:url("/assets/img/banner.svg");background-color:#3a3a3a;background-size:cover;background-position:center center;padding:0;height:auto;margin-bottom:16px}.header .navigation{background:#262626}.header .nav-container{max-width:1000px;margin:0 auto}@media(min-width: 600px){.header{min-height:10em;position:relative;margin-bottom:16px}}nav{height:70px;overflow:hidden}nav ul{margin:0;padding:0;list-style-type:none;max-height:140px;position:relative}nav ul .active{background:#3d256d}nav li{display:inline-block;padding:0}nav a{display:inline-block;padding:0 1em;color:#fff;text-decoration:none;white-space:nowrap;line-height:70px;height:70px}nav a:hover{color:#fff;background-color:#00b2d9}nav li:first-child{left:0;vertical-align:top;font-size:75%}nav li:first-child :hover{color:#fff;background-color:#262626}@media(min-width: 330px){nav li:first-child{font-size:100%}}@media(min-width: 400px){nav li:first-child{font-size:140%}}nav li:last-child{position:absolute;right:0;bottom:70px;background-image:linear-gradient(to right, rgba(38, 38, 38, 0) 0, #262626 2em);padding-left:3em}nav li:nth-last-child(2){display:none}nav#menu:target{height:auto;padding:0}nav#menu:target ul{max-height:none}nav#menu:target li{display:block}nav#menu:target a{display:block;background-color:hsla(0,0%,100%,.05)}nav#menu:target li:not(:first-child){margin-top:2px}nav#menu:target li:not(:first-child) a:hover{background-color:#00b2d9}nav#menu:target li:last-child{display:none}nav#menu:target li:nth-last-child(2){display:inline-block;position:absolute;top:0;right:0;margin:0;border-left:2px solid #262626;background:#3a3a3a}
      
    </style>

    <!-- Contain all special checks needed on AMP pages. Attempt to consolidate checks. -->


  
  <!-- Extract extra <title> tag. -->
  
  
  
  

  
  
  
  

  
    <!-- Begin Jekyll SEO tag v2.8.0 -->

<meta name="generator" content="Jekyll v4.4.1" />

<meta name="author" content="Kyle Niewiada" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="How I’m deploying smart plugs flashed with ESPHome to supersede Z-Wave. My ESPHome plugs are cheaper, easier to manage, and more reliable than ever before." />
<meta property="og:description" content="How I’m deploying smart plugs flashed with ESPHome to supersede Z-Wave. My ESPHome plugs are cheaper, easier to manage, and more reliable than ever before." />
<link rel="canonical" href="https://www.kyleniewiada.org/blog/2020/07/replacing-z-wave-with-esphome/" />
<meta property="og:url" content="https://www.kyleniewiada.org/blog/2020/07/replacing-z-wave-with-esphome/" />
<meta property="og:site_name" content="Kyle Niewiada’s Website" />
<meta property="og:image" content="https://www.kyleniewiada.org/assets/img/2020/07/sonoff_s31_plugs_disassembled.jpg" />
<meta property="og:image:height" content="600" />
<meta property="og:image:width" content="800" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-07-19T10:58:00-04:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://www.kyleniewiada.org/assets/img/2020/07/sonoff_s31_plugs_disassembled.jpg" />
<meta property="twitter:title" content="Deploying ESPHome Smart Plugs to Replace Z-Wave" />
<meta name="twitter:site" content="@CrypticCitrus" />
<meta name="twitter:creator" content="@CrypticCitrus" />
<meta property="fb:app_id" content="137961485759" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Kyle Niewiada"},"dateModified":"2020-07-19T10:58:00-04:00","datePublished":"2020-07-19T10:58:00-04:00","description":"How I’m deploying smart plugs flashed with ESPHome to supersede Z-Wave. My ESPHome plugs are cheaper, easier to manage, and more reliable than ever before.","headline":"Deploying ESPHome Smart Plugs to Replace Z-Wave","image":{"height":600,"width":800,"url":"https://www.kyleniewiada.org/assets/img/2020/07/sonoff_s31_plugs_disassembled.jpg","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.kyleniewiada.org/blog/2020/07/replacing-z-wave-with-esphome/"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://www.kyleniewiada.org/assets/img/logo.png"},"name":"Kyle Niewiada"},"url":"https://www.kyleniewiada.org/blog/2020/07/replacing-z-wave-with-esphome/"}</script>
<!-- End Jekyll SEO tag -->

  



     <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-ZP46JK222K"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-ZP46JK222K');
</script> 
</head>


  <body>
  <!-- start header -->
<header class="header">
  <div class="navigation">
    <div class="nav-container">
      <nav id="menu">
        <ul class="menu-closed">
          
            
            <li class="normal"><a href="/">Kyle Niewiada</a></li>
          
            
            <li class="normal"><a href="/">Home</a></li>
          
            
            <li class="normal"><a href="/about/">About</a></li>
          
            
            <li class="normal"><a href="/archive/">Archive</a></li>
          
            
            <li class="normal"><a href="/contact/">Contact</a></li>
          
            
            <li class="normal"><a href="/resume/">Résumé</a></li>
          
          <li><a href="#">&#215; Close menu</a></li>
          <li><a href="#menu">&#9776; Menu</a></li>
        </ul>
      </nav>
    </div>
  </div>
</header>
<!-- end header -->

    <main class="content">
    <!-- lazy way to hide page title on blog posts -->
    

    <article>
  <header>
    <h1 class="page-title">Deploying ESPHome Smart Plugs to Replace Z-Wave</h1>

    <h2 class="meta">Kyle Niewiada on July 19, 2020</h2>

    <h3 class="meta">
      
      6 Minute Read
       | Medium project</h3>
  </header>

  
  <h4 class="sub-meta">Updated on May 29, 2025</h4>
    

  
  <img src="/assets/img/2020/07/sonoff_s31_plugs_disassembled.jpg" alt="Disassembled Sonoff S31 plugs" />
  

  <div class="line-separator"></div>

  <p>About a year ago <a href="/blog/2019/05/trading-nest-for-tensorflow/">I went on a crusade</a> to transition my smart home devices to something that could be controlled locally. The goal was to remove any need for external cloud services. One of the ways that I did this was through buying Z-Wave devices. For the uninitiated, the Z-Wave protocol operates on a different frequency than the 2.4 GHz spectrum. This leads to less interference from poorly shielded microwaves, slower Wi-Fi devices, and avoids spectrum congestion from devices like Hue bulbs (which operate closely to some 2.4 GHz Wi-Fi channels).</p>
<h2 id="the-wrong-decision">
  
  
    The Wrong Decision <a href="#the-wrong-decision" aria-hidden="true" tabindex="-1"><svg class='octicon' viewBox='0 0 16 16' version='1.1' width='16' height='32' aria-hidden='true'><path fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z'></path></svg></a>
  
  
</h2>
    

<p>I am willing to admit that I made the wrong decision last year when I decided to buy into Z-Wave. On paper, it was a dream to operate on an uncongested wireless spectrum. The reality is that <a href="https://github.com/OpenZWave/open-zwave/issues/2215">some Z-Wave devices ship with bugs</a>. It’s not always possible to apply an update unless you have a responsible manufacturer and the ability to apply the patch. This means you could be permanently reliant on downstream patches to get the full functionality out of the device. The broadcast range for Z-Wave devices is not great for our small apartment. I frequently notice state changes will get lost if the Z-Wave device is too far away from the nearest repeater.</p>
<h2 id="fuel-to-the-fire">
  
  
    Fuel to the Fire <a href="#fuel-to-the-fire" aria-hidden="true" tabindex="-1"><svg class='octicon' viewBox='0 0 16 16' version='1.1' width='16' height='32' aria-hidden='true'><path fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z'></path></svg></a>
  
  
</h2>
    

<p>To add on to my frustration, the 7x Zooz Zen15 smart plugs that I purchased (across four different batches) required three separate RMA’s within one year. Each of the RMA’s was due to faulty power reading spikes which would cause the overcharge protection to trigger and shut off the plug.</p>

<p>Through some extensive testing I found this to be a fault within the plug each time. I was able to prove this by placing a Kill A Watt electricity usage monitor between the wall and the Zen15 plug. The Kill A Watt was able to contradict any readings broadcast by the Zen15. Except this kept happening with brand-new replacements after only a few months.</p>

<p>There are probably a lot of contributing factors to the failures of the plugs I’m not seeing. Maybe they are more sensitive to electrical fluctuations than other devices in our house. The only thing that I know is I have given up on them.</p>

<p>After repeated failures of the Zen15 plugs and buggy firmware from Z-Wave devices I was ready to distance* myself as much as possible from Z-Wave.</p>

<blockquote>
  <p>*Pun intended. Except Z-Wave wouldn’t get the joke since the signal would never reach that far. 🔥</p>
</blockquote>
<h2 id="thinking-back-to-esphome">
  
  
    Thinking Back to ESPHome <a href="#thinking-back-to-esphome" aria-hidden="true" tabindex="-1"><svg class='octicon' viewBox='0 0 16 16' version='1.1' width='16' height='32' aria-hidden='true'><path fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z'></path></svg></a>
  
  
</h2>
    

<p>Around this time last year, <a href="/blog/2019/02/hacking-my-noise-machine/">I modified a noise machine with a NodeMCU board</a> to control the power and state reporting of the box. The board I installed inside the noise machine was flashed with <a href="https://esphome.io/">ESPHome</a>– a wonderful custom firmware that can be applied to ESP8266 and ESP32 devices. My experience with managing and updating ESPHome devices has been so smooth that it influenced my final decision on what to replace my Z-Wave plugs with.</p>

<p>On my quest for new smart plugs I was looking for the plug to:</p>

<ul>
  <li>Handle 15 A</li>
  <li>Maintain a stable connection</li>
  <li>Fit a small profile</li>
  <li>Update easily</li>
  <li>Obfuscate or resolve states before emitting to simplify upstream controls</li>
</ul>

<p>After a bit of hunting around the <a href="https://www.reddit.com/r/HomeAssistant"><code class="language-plaintext highlighter-rouge">/r/HomeAssistant</code></a> subreddit, I ended up picking the Sonoff S31 smart plugs with ESPHome.</p>

<p>I chose these specific plugs because disassembling/reassembling them is nondestructive. They have plastic edges that slide out to reveal hidden screws. This means I can reassemble them without chipping plastic or gouging edges.</p>

<p><img src="/assets/img/2020/07/sonoff_s31_plugs_disassembled.jpg" alt="Disassembled Sonoff S31 plugs" /><em>Sonoff S31 plugs disassembled and ready to flash</em></p>
<h2 id="preparing">
  
  
    Preparing <a href="#preparing" aria-hidden="true" tabindex="-1"><svg class='octicon' viewBox='0 0 16 16' version='1.1' width='16' height='32' aria-hidden='true'><path fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z'></path></svg></a>
  
  
</h2>
    

<p>The Sonoff S31 plugs require a USB to serial adapter and a <a href="https://tasmota.github.io/docs/devices/Sonoff-S31/">small bit of soldering</a> to flash ESPHome onto. This is usually the part where I would show a picture of my smart plugs with the soldered wires leading off.</p>

<p><del><em>Not a chance</em> 👎. The truth is that my soldering job on these plugs was awful. Cold joints and singed pads everywhere. Thankfully after flashing each plug, I was able to remove my terrible solder negating most ill effects.</del></p>

<blockquote>
  <p><strong>EDIT (2020-07-23)</strong>: During my reflection phase I was motivated to upgrade my soldering iron and try again. <em>What a difference that made</em>. I also discovered that my Dupont wires were copper-clad aluminum instead of pure copper. This made soldering to the cheap wires problematic. To make it easier (and less destructive) I attempted the <em>temporary</em> solder joint again with the Dupont connector pins with passable results.</p>
</blockquote>

<p><img src="/assets/img/2020/07/sonoff_s31_hookup.jpg" alt="Flashing a Sonoff S31 plug soldered to a USB to serial adapter" /><em>Flashing a Sonoff S31 plug with my ESPHome firmware</em></p>

<blockquote>
  <p>In the end I only destroyed 1 of 10 Sonoff S31 plugs I purchased. That is a 90% success rate! 🎉</p>
</blockquote>

<p><img src="/assets/img/2020/07/sonoff_s31_plugs.jpg" alt="Sonoff S31 plugs alongside a USB to serial adapter" /><em>Sonoff S31 plugs flashed with ESPHome ready for calibration</em></p>
<h2 id="configuring">
  
  
    Configuring <a href="#configuring" aria-hidden="true" tabindex="-1"><svg class='octicon' viewBox='0 0 16 16' version='1.1' width='16' height='32' aria-hidden='true'><path fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z'></path></svg></a>
  
  
</h2>
    

<p>Here is a sample from my ESPHome configuration for one of my deployed smart plugs.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Basic Config</span>
<span class="c1"># sonoff-s31-01</span>
<span class="c1"># Flower lamp</span>
<span class="c1"># Updated for 2025.5.0</span>

<span class="na">substitutions</span><span class="pi">:</span>
  <span class="na">board_id</span><span class="pi">:</span> <span class="s">sonoff-s31-01</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">flower-lamp</span>
  <span class="na">friendly_name</span><span class="pi">:</span> <span class="s">Flower lamp</span>

<span class="na">wifi</span><span class="pi">:</span>
  <span class="na">ssid</span><span class="pi">:</span> <span class="kt">!secret</span> <span class="s">wifi_ssid</span>
  <span class="na">password</span><span class="pi">:</span> <span class="kt">!secret</span> <span class="s">wifi_password</span>

  <span class="c1"># Enable fallback hotspot (captive portal) in case wifi connection fails</span>
  <span class="na">ap</span><span class="pi">:</span>
    <span class="na">ssid</span><span class="pi">:</span> <span class="s2">"</span><span class="s">${board_id}</span><span class="nv"> </span><span class="s">Hotspot"</span>
    <span class="na">password</span><span class="pi">:</span> <span class="kt">!secret</span> <span class="s">ap_hotspot_password</span>

  <span class="na">reboot_timeout</span><span class="pi">:</span> <span class="s">6h</span>

<span class="c1"># Enable captive portal if wifi ever changes</span>
<span class="na">captive_portal</span><span class="pi">:</span>

<span class="c1"># Enable Home Assistant API</span>
<span class="na">api</span><span class="pi">:</span>
  <span class="na">encryption</span><span class="pi">:</span>
    <span class="na">key</span><span class="pi">:</span> <span class="kt">!secret</span> <span class="s">encryption_pre_shared_key</span>

<span class="na">ota</span><span class="pi">:</span>
  <span class="na">platform</span><span class="pi">:</span> <span class="s">esphome</span>
  <span class="na">password</span><span class="pi">:</span> <span class="kt">!secret</span> <span class="s">ota_password</span>

<span class="na">esphome</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">${name}</span>
  <span class="na">comment</span><span class="pi">:</span> <span class="s">${board_id}</span>
  <span class="na">friendly_name</span><span class="pi">:</span> <span class="s">${friendly_name}</span>

<span class="na">esp8266</span><span class="pi">:</span>
  <span class="na">board</span><span class="pi">:</span> <span class="s">esp01_1m</span>
  <span class="na">restore_from_flash</span><span class="pi">:</span> <span class="kc">false</span>

<span class="c1"># Enable logging</span>
<span class="na">logger</span><span class="pi">:</span>
  <span class="na">baud_rate</span><span class="pi">:</span> <span class="m">0</span>  <span class="c1"># (UART logging interferes with cse7766)</span>

<span class="c1"># Device Specific Config</span>
<span class="na">uart</span><span class="pi">:</span>
  <span class="na">rx_pin</span><span class="pi">:</span> <span class="s">RX</span>
  <span class="na">baud_rate</span><span class="pi">:</span> <span class="m">4800</span>
  <span class="na">parity</span><span class="pi">:</span> <span class="s">EVEN</span>

<span class="na">status_led</span><span class="pi">:</span>
  <span class="na">pin</span><span class="pi">:</span> <span class="s">GPIO13</span>

<span class="c1"># Enable time component to reset energy at midnight</span>
<span class="na">time</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">sntp</span>
    <span class="na">id</span><span class="pi">:</span> <span class="s">my_time</span>

<span class="na">sensor</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">wifi_signal</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">WiFi</span><span class="nv"> </span><span class="s">Signal"</span>
    <span class="na">update_interval</span><span class="pi">:</span> <span class="s">300s</span>
  <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">total_daily_energy</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Total</span><span class="nv"> </span><span class="s">Daily</span><span class="nv"> </span><span class="s">Energy"</span>
    <span class="na">power_id</span><span class="pi">:</span> <span class="s">power</span>
    <span class="na">accuracy_decimals</span><span class="pi">:</span> <span class="m">3</span>
    <span class="na">unit_of_measurement</span><span class="pi">:</span> <span class="s">kWh</span>
    <span class="na">filters</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">multiply</span><span class="pi">:</span> <span class="m">0.001</span>
  <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">cse7766</span>
    <span class="na">current</span><span class="pi">:</span>
      <span class="na">internal</span><span class="pi">:</span> <span class="kc">true</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Current"</span>
      <span class="na">unit_of_measurement</span><span class="pi">:</span> <span class="s">A</span>
      <span class="na">accuracy_decimals</span><span class="pi">:</span> <span class="m">3</span>
      <span class="na">filters</span><span class="pi">:</span>
        <span class="c1"># Map from sensor -&gt; measured value</span>
        <span class="pi">-</span> <span class="na">calibrate_linear</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">0 -&gt; </span><span class="m">0</span>
          <span class="pi">-</span> <span class="s">3.8 -&gt; </span><span class="m">3.957</span>
          <span class="pi">-</span> <span class="s">5.9 -&gt; </span><span class="m">6.099</span>
          <span class="pi">-</span> <span class="s">12.7 -&gt; </span><span class="m">13.046</span>
        <span class="pi">-</span> <span class="na">throttle_average</span><span class="pi">:</span> <span class="s">30s</span>
        <span class="c1"># Make everything below 0.01A appear as just 0A.</span>
        <span class="c1"># Furthermore it corrects 0.016A for the power usage of the plug.</span>
        <span class="pi">-</span> <span class="na">lambda</span><span class="pi">:</span> <span class="s">if (x &lt; (0.01 - 0.016)) return 0; else return (x - 0.016);</span>
    <span class="na">voltage</span><span class="pi">:</span>
      <span class="na">internal</span><span class="pi">:</span> <span class="kc">true</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Voltage"</span>
      <span class="na">unit_of_measurement</span><span class="pi">:</span> <span class="s">V</span>
      <span class="na">accuracy_decimals</span><span class="pi">:</span> <span class="m">1</span>
      <span class="na">filters</span><span class="pi">:</span>
        <span class="c1"># Map from sensor -&gt; measured value</span>
        <span class="pi">-</span> <span class="na">calibrate_linear</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">117.6 -&gt; </span><span class="m">118.43</span>
          <span class="pi">-</span> <span class="s">116.8 -&gt; </span><span class="m">117.66</span>
          <span class="pi">-</span> <span class="s">116.1 -&gt; </span><span class="m">116.87</span>
          <span class="pi">-</span> <span class="s">114.3 -&gt; </span><span class="m">115.33</span>
        <span class="pi">-</span> <span class="na">throttle_average</span><span class="pi">:</span> <span class="s">30s</span>
    <span class="na">power</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Power"</span>
      <span class="na">id</span><span class="pi">:</span> <span class="s">power</span>
      <span class="na">unit_of_measurement</span><span class="pi">:</span> <span class="s">W</span>
      <span class="na">accuracy_decimals</span><span class="pi">:</span> <span class="m">0</span>
      <span class="na">filters</span><span class="pi">:</span>
        <span class="c1"># Map from sensor -&gt; measured value</span>
        <span class="pi">-</span> <span class="na">calibrate_linear</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">0 -&gt; </span><span class="m">0</span>
          <span class="pi">-</span> <span class="s">451.5 -&gt; </span><span class="m">463.9</span>
          <span class="pi">-</span> <span class="s">687.4 -&gt; </span><span class="m">705.53</span>
          <span class="pi">-</span> <span class="s">1446.3 -&gt; </span><span class="m">1482.9</span>
        <span class="pi">-</span> <span class="na">throttle_average</span><span class="pi">:</span> <span class="s">30s</span>
        <span class="c1"># Make everything below 2W appear as just 0W.</span>
        <span class="c1"># Furthermore it corrects 0.91W for the power usage of the plug.</span>
        <span class="pi">-</span> <span class="na">lambda</span><span class="pi">:</span> <span class="s">if (x &lt; (2 + 0.91)) return 0; else return (x - 0.91);</span>
    
<span class="na">output</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">gpio</span>
    <span class="na">id</span><span class="pi">:</span> <span class="s">light_relay</span>
    <span class="na">pin</span><span class="pi">:</span> <span class="s">GPIO12</span>

<span class="na">binary_sensor</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">gpio</span>
    <span class="na">id</span><span class="pi">:</span> <span class="s">button</span>
    <span class="na">pin</span><span class="pi">:</span>
      <span class="na">number</span><span class="pi">:</span> <span class="s">GPIO0</span>
      <span class="na">mode</span><span class="pi">:</span> <span class="s">INPUT_PULLUP</span>
      <span class="na">inverted</span><span class="pi">:</span> <span class="s">True</span>
    <span class="na">on_press</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">light.toggle</span><span class="pi">:</span> <span class="s">light_switch</span>
        
<span class="na">light</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">binary</span>
    <span class="na">id</span><span class="pi">:</span> <span class="s">light_switch</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">None</span>
    <span class="na">output</span><span class="pi">:</span> <span class="s">light_relay</span>         
</code></pre></div></div>

<blockquote>
  <p>Note that there are custom calibration data points around the electricity monitoring sensors. I wanted extremely accurate power consumption metrics from each plug.</p>
</blockquote>

<p>Armed with a hairdryer, Kill A Watt electricity usage monitor, phone camera stream, log viewer, and a tool for capturing screenshots I was able to collect custom data points for electricity usage on each plug. These custom data points allow me to set perfect calibrations for each individual plug rather than assuming identical profiles for each device.</p>

<p><img src="/assets/img/2020/07/sonoff_s31_calibration.png" alt="Results of recorded vs measured values for Sonoff S31 plugs" /><em>Custom calibration values for one of my ESPHome plugs</em></p>

<blockquote>
  <p>Frenck has an excellent blog post that goes over <a href="https://frenck.dev/calibrating-an-esphome-flashed-power-plug/">how to calibrate an ESPHome power plug</a>. I would highly recommend giving it a read.</p>
</blockquote>

<p>After calibration, everything else was easy. <a href="https://www.home-assistant.io/integrations/esphome/">Following the docs</a>, I connected the ESPHome devices up to Home Assistant and placed them on my dashboard.</p>

<p><img src="/assets/img/2020/07/home_assistant_power_dashboard.png" alt="Home Assistant dashboard showing ESPHome plugs, power, and energy usage" /><em>Home Assistant dashboard with ESPHome plugs added</em></p>
<h2 id="what-will-i-do-with-the-data">
  
  
    What Will I Do With the Data? <a href="#what-will-i-do-with-the-data" aria-hidden="true" tabindex="-1"><svg class='octicon' viewBox='0 0 16 16' version='1.1' width='16' height='32' aria-hidden='true'><path fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z'></path></svg></a>
  
  
</h2>
    

<p>My plan is to use the electricity data to adjust living habits and support new automations.</p>

<p>For example, I want to know how much power (and consequently cost) our dehumidifier is consuming. This allows me to have as a comparison against our comfort level for each humidity setting. The lower we want the humidity, the higher the power consumption/cost. My goal is to approach a happy medium.</p>

<p>I also want to feed my curiosity on how much power devices consume throughout the course of a 24-hour period. But not <em>just</em> the total consumption– I want to see the rate of consumption throughout a given window.</p>
<h2 id="conclusion">
  
  
    Conclusion <a href="#conclusion" aria-hidden="true" tabindex="-1"><svg class='octicon' viewBox='0 0 16 16' version='1.1' width='16' height='32' aria-hidden='true'><path fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z'></path></svg></a>
  
  
</h2>
    

<p>This project to replace my Z-Wave smart plugs came about because I was frustrated with the intricacies of Z-Wave, disappointed in the stability, accustomed to state reporting errors, and had a hard time justifying the expensive hardware cost. The low-power devices are nice, but I do not think they warrant the time spent troubleshooting to keep them working.</p>

<p>After selling 6x Zooz Zen15 plugs, my Z-Wave network has shrunk to a thermostat, 1 button, and an unused wall plug (acting as a repeater because Z-Wave reception is so poor). I think I can envision a future where I have removed the remaining devices.</p>

<p>I was driven by frustration to replace my Z-Wave plugs with something reliable and easy to manage. In the end my solution with ESPHome plugs were cheaper, easier to manage, and more reliable. Now every smart plug on my network can be controlled reliably. The best part is that they <em>actually</em> work. That is all I ever wanted.</p>

  <div class="line-separator"></div>

  <!-- POST NAVIGATION -->
<div class="post-nav">
  
    <a class="post-nav-link" href="/blog/2019/12/achieving-remote-starter-serenity/">
    <div class="link-text previous">&laquo;&nbsp;Achieving Remote Starter Serenity</div>
    
      <img class="link-image" src="/assets/img/2019/12/rear_defogger_on.jpg" alt="Previous Article">
    
    </a>
  
  
    <a class="post-nav-link" href="/blog/2020/07/appliance-notifications-through-vibration-and-power/">
    <div class="link-text next">Using Vibrations and Power to Notify When My Washing Machine and Dryer Finish&nbsp;&raquo;</div>
    
      <img class="link-image" src="/assets/img/2020/07/dryer_vibration_monitor.jpg" alt="Next Article">
    
    </a>
  
</div>

</article>


    
<!-- Add Disqus comments. -->
<div id="disqus_thread"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'kyleniewiada'; // required: replace example with your forum shortname
  var disqus_identifier = "/blog/2020/07/replacing-z-wave-with-esphome/";

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



    </main>
  <!-- start footer -->
<footer class="content">
  <div class="flex-list">
  <ul>
  
    <li>
      <a href="https://www.linkedin.com/in/kyleniewiada/" >LinkedIn</a>
    </li>
  
    <li>
      <a href="https://github.com/aav7fl" >GitHub</a>
    </li>
  
    <li>
      <a href="https://bsky.app/profile/crypticcitrus.bsky.social" >Bluesky</a>
    </li>
  
    <li>
      <a href="https://www.youtube.com/user/KyleNiewiada" >YouTube</a>
    </li>
  
    <li>
      <a href="https://kyleniewiada.bandcamp.com/" rel='nofollow'>BandCamp</a>
    </li>
  
    <li>
      <a href="/sitemap/" >Sitemap</a>
    </li>
  
  </ul>
</div>

</footer>
<!-- start noncritical style -->
<link rel="preload" href="/assets/css/noncritical.css" as="style" onload="this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="/assets/css/noncritical.css"></noscript>
<script>
  /*loadCss*/
  !function(w){"use strict";var loadCSS=function(href,before,media){function ready(cb){return doc.body?cb():void setTimeout(function(){ready(cb)})}function loadCB(){ss.addEventListener&&ss.removeEventListener("load",loadCB),ss.media=media||"all"}var ref,doc=w.document,ss=doc.createElement("link");if(before)ref=before;else{var refs=(doc.body||doc.getElementsByTagName("head")[0]).childNodes;ref=refs[refs.length-1]}var sheets=doc.styleSheets;ss.rel="stylesheet",ss.href=href,ss.media="only x",ready(function(){ref.parentNode.insertBefore(ss,before?ref:ref.nextSibling)});var onloadcssdefined=function(cb){for(var resolvedHref=ss.href,i=sheets.length;i--;)if(sheets[i].href===resolvedHref)return cb();setTimeout(function(){onloadcssdefined(cb)})};return ss.addEventListener&&ss.addEventListener("load",loadCB),ss.onloadcssdefined=onloadcssdefined,onloadcssdefined(loadCB),ss};"undefined"!=typeof exports?exports.loadCSS=loadCSS:w.loadCSS=loadCSS}("undefined"!=typeof global?global:this);

  /*link[rel=preload] polyfill*/
  !function(w){if(w.loadCSS){var rp=loadCSS.relpreload={};if(rp.support=function(){try{return w.document.createElement("link").relList.supports("preload")}catch(e){return!1}},rp.poly=function(){for(var links=w.document.getElementsByTagName("link"),i=0;i<links.length;i++){var link=links[i];"preload"===link.rel&&"style"===link.getAttribute("as")&&(w.loadCSS(link.href,link),link.rel=null)}},!rp.support()){rp.poly();var run=w.setInterval(rp.poly,300);w.addEventListener&&w.addEventListener("load",function(){w.clearInterval(run)}),w.attachEvent&&w.attachEvent("onload",function(){w.clearInterval(run)})}}}(this);
</script>
<!-- end noncritical style -->
<!-- end footer -->

  </body>
</html>
